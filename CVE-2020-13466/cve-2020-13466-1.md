# A QUICK(ish) LOOK AT STM32 HARDWARE SECURITY (PART 2)

***28/12/21***

***Continue from [the last part](../CVE-2020-13466/cve-2020-13466.md). In this post I'll attempt to perform physical attack on STM32F1, I will follow \[[1]\] and go through 3 different setups and test if the exploit is successful or not.***

***TL,DR: Exploit failed, I will investigate further in future post.***

## 1. CVE-2020-13466 Briefing

From the paper, exploitation process is executed in few stages:

  1. Setup - In this stage, we use a debugger to load exploitation firmware \[[2]\] into SRAM of our target, this firmware will configure Flash Patch and Breakpoint Unit (FPB). Boot mode is then set to SRAM.
  2. Glitch - The power glitch is executed in this stage. Power is turned off for a fraction of a second, enough to reset flash lock from debugger access in previous stage but not long enough for SRAM to lose their data. The firmware will configure FPB.
  3. Reset - Boot mode is set back to flash, then apply reset signal. FPB configuration remains. Boot is diverted to SRAM code. Flash is accesible since the device boot from flash.

## 2. Setup

I'll leave boring reading part in the next post. we go hands on this time.

During my experiment with this vulnerability I came up with 3 different hardware setups. But due to a bad USB, all data (waveform, images...) of first 2 setups are lost. You will have to take my words for it.

All setup will use a control board to control boot mode and monitor target board rst line. Control board is overclocked to 128Mhz with libopencm3.

The target is a bluepill board loaded with blink.

### 2.1. First Setup

![1st_setup](./imgs/1st_setup.svg)

At first, I attempted to create a proper programable power supply to the target board with a transistor and a isolated power supply module.

The reason for the isolated power supply is if I were to put the target board directly as load, I cannot use oscilloscope to measure signal from control board and target board at the same time, since probes share the same ground and would short out the transitor, making it useless.

However, with isolated power, the ground of 2 sides still connect through the scope.

Using this setup to cut power. The fall time measured for target power line is horrible, it takes more than 500 us to trigger the target reset. Although rise time is closer to what described in the paper, it probably still not ideal. The exploit does not work.

### 2.2. Second Setup

![2st_setup](./imgs/2nd_setup.svg)

Reading instructions in \[[2]\]. I removed the \'power supply\' part entirely, 2 pins is now used to drive the target\'s power.

### 2.3. After Removing Bypass Caps

![3rd_setup](./imgs/2nd_setup_.jpg)

![wave_cap_removed](./imgs/waveform_cap_removed.png)

## References

1. [https://www.usenix.org/conference/woot20/presentation/obermaier](https://www.usenix.org/conference/woot20/presentation/obermaier)
2. [https://github.com/JohannesObermaier/f103-analysis/tree/master/h3](https://github.com/JohannesObermaier/f103-analysis/tree/master/h3)
3. [https://stm32-base.org/assets/pdf/boards/original-schematic-STM32F103C8T6-Blue_Pill.pdf](https://stm32-base.org/assets/pdf/boards/original-schematic-STM32F103C8T6-Blue_Pill.pdf)

[1]: https://www.usenix.org/conference/woot20/presentation/obermaier
[2]: https://github.com/JohannesObermaier/f103-analysis/tree/master/h3
[3]: https://stm32-base.org/assets/pdf/boards/original-schematic-STM32F103C8T6-Blue_Pill.pdf
